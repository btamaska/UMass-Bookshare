var leven = require("levenshtein");
var book_i = require("DB_book");
var user_i = require("DB_user");
var DB_Interface = require("DB_Interface");
var Promise = require('bluebird');
var sequelize = DB_Interface.getServer;

exports.search = exports.searchHandler = function searchHandler(query_, function_)
{
	var splitQuery = query_.replace(/\W/g, ' ').split(" ");
	var promisesAr = [];
	for(var i = 0; i < splitQuery.length; i++){
		// var bookresults = sequelize.query(
		// 	"SELECT * FROM book WHERE isbn10 = \'" +splitQuery[i]+ "\' OR isbn13 = \'" +splitQuery[i]+ "\' OR title LIKE \'%" +splitQuery[i]+ "%\' OR author LIKE \'%" +splitQuery[i]+ "%\';", book_i.booktable
		//  );
		// var userresults = sequelize.query(
		// 	"SELECT * FROM users WHERE username LIKE \'%" +splitQuery[i]+ "%\';", user_i.userstable
		// );

		var results = sequelize.query("SELECT * FROM book WHERE isbn10 = \'" +splitQuery[i]+ "\' OR isbn13 = \'" +splitQuery[i]+ "\' OR title LIKE \'%" +splitQuery[i]+ "%\' OR author LIKE \'%" +splitQuery[i]+ "%\' JOIN SELECT * FROM users WHERE username LIKE \'%" +splitQuery[i]+ "%\';");
		promisesAr.push(bookresults);
		promisesAr.push(userresults);
	}
	Promise.all(promisesAr).then(function(records){
		probHandler(records);
	});
}

function probHandler(results_, queryCount)
{
	var formedResults = [];
	// for(var i = 0; i < )
	console.log(results_);
	// console.log(results_[3][1].rowCount);
	//Format results
	// for(var i = 0; i < results_[3][1].rowCount; i++)
	// {
	// 	formedResults.push({
	// 		username : results_[3][0][i].username.trim(),
	// 	});
	// }
	// console.log(formedResults);
}