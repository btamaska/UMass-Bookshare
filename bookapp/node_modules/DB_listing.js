var Sequelize = require("sequelize");
var exports = module.exports = {};
var DB_Interface = require("DB_Interface");
var uuid = require("uuid");
var sequelize = DB_Interface.getServer;
var bookInterface = require("DB_book");
var bookTable = bookInterface.table;
var userInterface = require("DB_user");
var userTable = userInterface.table;

var ListTable = sequelize.define("listing",{
	listid :{ 
		type : Sequelize.STRING(32),
        primaryKey: true,
	},
	username: {
		type: Sequelize.STRING(20),
	},
	isbn13: Sequelize.STRING(13),
	forrent: Sequelize.BOOLEAN,
	forsale: Sequelize.BOOLEAN,
	forborrow: Sequelize.BOOLEAN,
	available: Sequelize.BOOLEAN,
	listdate: Sequelize.DATE},
	{
		timestamps: false,
    	freezeTableName: true,
    	tableName: "listing"
	}
	);

ListTable.belongsTo(bookTable, { foreignKey: "isbn13" });
ListTable.belongsTo(userTable, { foreignKey: "username" });

exports.makeListing = function makeListing_(username_, isbn13_, forRent_, forSale_, forBorrow_, function_)
{
	listID_ = uuid.generateUUID().substring(0,32);
	var d = new Date();
	found = ListTable.findOrCreate({where : {listid : listID_},
		defaults:{
			listid : listID_,
			username : username_,
			isbn13 : isbn13_,
			forrent : forRent_,
			forsale : forSale_,
			forborrow : forBorrow_,
			available : true,
			listdate : d.toString(d.getTime())
		}
	});
	found.then(function(record){
		if(record[0].options.isNewRecord){
			function_(record);
		}
		else{
			makeListing_(username_, isbn13_, forRent, forSale, forBorrow, function_); //try again w/ another UUID, lol, what are the odds? (functionally 0).
		}
	});
}

exports.getListing = function getListing_(listid_, function_)
{
	found = ListTable.findOne(
		{where : {listid : listid_},
	});
	found.then(function(record){
		var listValues = null;
		if(record != null)
		{
			listValues = {
				listid : record.dataValues.listid,
				username : record.dataValues.username.trim(),
				isbn13 : record.dataValues.isbn13,
				forrent : record.dataValues.forrent,
				forsale : record.dataValues.forsale,
				foreborrow : record.dataValues.forborrow,
				available : record.dataValues.available,
				listdate : record.dataValues.listdate
			}
		}
		function_(listValues);
	});
}

exports.findUsersListing = function findUserListing_(username_, function_)
{
	found = ListTable.findAll(
		{where : [{username : username_}, {available : true}]
	});
	found.then(function(record) {
		if(record != null)
		{
			var listValues = [];
			for(var i = 0; i < record.length; i++){
				listValues[i] = {
					listid : record[i].dataValues.listid,
					username : record[i].dataValues.username.trim(),
					isbn13 : record[i].dataValues.isbn13,
					forrent : record[i].dataValues.forrent,
					forsale : record[i].dataValues.forsale,
					foreborrow : record[i].dataValues.forborrow,
					available : record[i].dataValues.available,
					listdate : record[i].dataValues.listdate
				}
			}
			function_(listValues);
		}
	});
}

exports.findBookListing = function findBookListing_(isbn13_, function_)
{
	found = ListTable.findAll(
		{where : [{isbn13 : isbn13_}, {available : true}]
	});
	found.then(function(record) {
		if(record != null)
		{
			var listValues = [];
			for(var i = 0; i < record.length; i++){
				listValues[i] = {
					listid : record[i].dataValues.listid,
					username : record[i].dataValues.username.trim(),
					isbn13 : record[i].dataValues.isbn13,
					forrent : record[i].dataValues.forrent,
					forsale : record[i].dataValues.forsale,
					foreborrow : record[i].dataValues.forborrow,
					available : record[i].dataValues.available,
					listdate : record[i].dataValues.listdate
				}
			}
			function_(listValues);
		}
	});
}

exports.postBookListing = function findBookListing_(isbn13_, res_)
{
	var found = sequelize.query(
			"SELECT * FROM listing WHERE isbn13 = \'" +isbn13_+ "\';", ListTable
			 );
	found.then(function(record) {
		console.log(record[1].rowCount);
		if(record != null)
		{
			var listValues = [];
			for(var i = 0; i < record[1].rowCount; i++){
				listValues[i] = {
					//do we need to put price in here?
					listid : record[0][i].listid,
					username : record[0][i].username.trim(),
					isbn13 : record[0][i].isbn13,
					forrent : record[0][i].forrent,
					forsale : record[0][i].forsale,
					foreborrow : record[0][i].forborrow,
					available : record[0][i].available,
					listdate : record[0][i].listdate,
					price : record[0][i].price
				}
			}
			hi = listValues;
			res_.render('../views/searchResult', hi);
		}
	});
}

exports.recentListing = function recentListing_(res_,req_)
{
	var found = sequelize.query(
			"Select listing.listid, listing.price, book.author, book.title FROM listing INNER JOIN book ON book.isbn13=listing.isbn13 ORDER BY listdate desc;");

	found.then(function(record) {
		console.log(record[1].rowCount);
		if(record != null)
		{
			var listValues = [];
			for(var i = 0; i < record[1].rowCount; i++){
				listValues[i] = {
					listid : record[0][i].listid,
					author : record[0][i].author,
					title  : record[0][i].title,
					price  : record[0][i].price
				}
			}
			recent = listValues;
			res_.render('../views/home', recent);
		}
	});
}

exports.makenotAvailable = function notAvailable_(listid_, function_)
{
	// found = ListTable.findOne(
	// 	{where : {listid : listid_},
	// });
	// found.then(function(record){
	// 	console.log(typeof function_ + " sfasdfasdfsda");
	// 	if(found){
	// 		console.log(typeof found + " dddsfasdfasdfsda");
	// 		found2 = found.updateAttributes({available : false});
	// 		console.log(typeof found2 + " daaaaddsfasdfasdfsda");
	// 		if(found2){
	// 			found2.then(function(record2){
	// 					console.log(typeof function_ + "sfasdfasdfsda");
	// 					function_(record2);
	// 				});
	// 		}
	// 	}
	// });

	var found3 = sequelize.query("UPDATE listing SET available = \'false\'  WHERE listid = \'" + listid_ +"\';", ListTable);
	found3.then(function(record){
		if(typeof function_ == "function"){}
			function_(record);
	});
}
